name: "Setup and build chart"
description: "Install dependencies, pull files and build the Rancher chart"
inputs:
  upload-artifact:
    description: "Whether to upload the chart as a GitHub Actions artifact"
    required: false
    default: "true"
runs:
  using: "composite"
  steps:
    - name: Install dependencies
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y jq gawk
    - name: Setup Tag Env Variables
      uses: ./.github/actions/setup-tag-env
    - name: Install yq
      uses: ./.github/actions/install-yq
      with:
        arch: ${{ env.ARCH }}
    - id: env
      name: Setup Dependencies Env Variables
      uses: ./.github/actions/setup-build-env
    - name: Install Helm dependencies
      env:
        HELM_URL: https://get.helm.sh/helm-${{ steps.env.outputs.HELM_VERSION }}-linux-amd64.tar.gz
        HELM_UNITTEST_VERSION: ${{ steps.env.outputs.HELM_UNITTEST_VERSION }}
      shell: bash
      run: |
        for i in {1..3}; do
          curl -sLf ${{ env.HELM_URL }} | tar xvzf - --strip-components=1 -C /tmp/ && break || sleep 5
        done
        mv /tmp/helm /usr/bin/helm_v3
        chmod +x /usr/bin/helm_v3
        for i in {1..3}; do
          helm_v3 plugin install https://github.com/helm-unittest/helm-unittest.git --version ${{ env.HELM_UNITTEST_VERSION }} && break || sleep 5
        done
    - name: Build
      shell: bash
      run: ./scripts/chart/build chart
    - name: Validate
      shell: bash
      run: ./scripts/chart/validate
    - name: Test
      shell: bash
      run: ./scripts/chart/test
    - name: Package
      shell: bash
      run: ./scripts/chart/package
    - name: Upload chart
      if: inputs.upload-artifact == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: chart
        path: ./bin/chart/*
        if-no-files-found: error
        retention-days: 4
        overwrite: true
